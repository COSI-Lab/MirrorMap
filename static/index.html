<!DOCTYPE HTML>

<html>
   <head>

      <link rel="stylesheet" href="style.css">
      
      <script type = "text/javascript">
         function WebSocketTest() {

            let xhr = new XMLHttpRequest();
            xhr.open('GET', 'http://localhost:8000/register');
            xhr.setRequestHeader('Access-Control-Allow-Headers', '*');
            xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
            xhr.send();
            xhr.onload = function() {
                console.log(xhr.response);
                var id = xhr.response
            
             
            //  var id = 
            
            if ("WebSocket" in window) {
               // alert("WebSocket is supported by your Browser!");
               
               // Let us open a web socket
               var url = "ws://localhost:8000/socket/" + id
               var ws = new WebSocket(url);
				
               ws.onmessage = function (evt) { 
                  var msg = evt.data;
                  let [lat, long] = msg.split(":")
                  lat = parseFloat(lat);
                  long = parseFloat(long);
                  let x = (lat + 180) / 360;
                  let y = (90 - long) / 180;
                  console.log(x, y)
                  circles.push([x, y]);
               };
				
               ws.onclose = function() { 
                  
                  // websocket is closed.
                  alert("Connection is closed\nrefresh to connect"); 
               };
            } else {
              
               // The browser doesn't support WebSocket
               alert("This site will not work since\nyour browser does not support websockets");
            }
         }
         }
      </script>
		
   </head>
   
   <body>
      <img id="map" src="map.jpg" alt="" style="display:none;">
      <div>
         <!-- <a href = "javascript:WebSocketTest()">Run WebSocket</a> -->
         <canvas id="myCanvas"></canvas>
         <script>         
         var circles = [];
         window.onload = async function() {
            WebSocketTest(circles);

            let canvas = document.getElementById("myCanvas");
            let ctx = canvas.getContext("2d");
            let img = document.getElementById("map");
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            ctx.drawImage(img, 0,0, window.innerWidth, window.innerHeight);

            while (true) {
               for (circle of circles) {
                  ctx.fillStyle = "#c82124";
                  ctx.beginPath();
                  ctx.arc(circle[0] * window.innerWidth, circle[1] * window.innerHeight, 3, 0, 2 * Math.PI, false);
                  ctx.closePath();
                  ctx.fill();
               }

               await new Promise(r => setTimeout(r, 1000));
            }
         }
         </script>

      </div>
      
   </body>
</html>